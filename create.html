<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buat Paste — PasteLink</title>
  <style>
    :root { color-scheme: light dark; }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto;margin:0;background:#0b0d12;color:#e7eaf0}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    .panel{background:#0f1420;border:1px solid #1d2743;border-radius:22px;padding:22px 22px 26px;box-shadow:0 20px 50px rgba(0,0,0,.35)}
    h1{margin:0 0 6px;font-size:clamp(22px,3.4vw,32px)}
    p.muted{opacity:.75;margin:.25rem 0 1rem}
    textarea{width:100%;min-height:360px;padding:14px;border-radius:16px;border:1px solid #2a3756;background:#0c1220;color:#e7eaf0}
    input[type="text"]{flex:1 1 260px;min-width:220px;padding:12px;border-radius:14px;border:1px solid #2a3756;background:#0c1220;color:#e7eaf0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:14px}
    button{padding:12px 16px;border-radius:14px;border:1px solid #304066;background:#121a2b;color:#e7eaf0;cursor:pointer}
    button.ghost{background:transparent}
    .card{border:1px dashed #2a3756;border-radius:16px;padding:14px;margin-top:14px}
    .link{word-break:break-all;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .stat{font-size:.92rem;opacity:.9;margin-top:8px}
    .ok{color:#8be38b}.warn{color:#ffcc66}.bad{color:#ff7b7b}
    .err{display:none;margin-top:10px;padding:10px;border-radius:10px;border:1px solid #5b2d2d;background:#2b1111;color:#ffd6d6}
    .info{display:none;margin-top:10px;padding:10px;border-radius:10px;border:1px solid #2a3756;background:#0c1220}
    .pill{display:inline-block;padding:3px 8px;border:1px solid #2a3756;border-radius:999px;background:#0c1220;margin-left:6px;font-size:.85rem}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="panel">
      <h1>Buat Paste</h1>
      <p class="muted">Teks akan <b>dikompres (gzip)</b> lalu di-encode ke <b>Base64URL</b> dan disimpan di <b>URL hash</b> — tanpa server.</p>

      <label class="muted">Isi</label>
      <textarea id="input" placeholder="Tempel teks / kode di sini..."></textarea>

      <div class="row">
        <input id="title" type="text" placeholder="(Opsional) Judul/slug, mis. catatan-api" />
        <button id="make">Bikin Link</button>
        <button id="clear" class="ghost">Bersihkan</button>
        <span id="support" class="pill">gzip: cek…</span>
      </div>

      <div id="info" class="info"></div>
      <div id="err" class="err"></div>
      <div id="stats" class="stat"></div>

      <div id="result" class="card" hidden>
        <div class="muted">Link paste kamu:</div>
        <div id="outlink" class="link"></div>
        <div class="row" style="margin-top:8px">
          <button id="copy">Copy Link</button>
          <button id="open">Buka Link</button>
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  // ===== Safe DOM refs
  const $ = sel => document.querySelector(sel);
  const input = $('#input'), title = $('#title'), makeBtn = $('#make'), clearBtn = $('#clear');
  const result = $('#result'), outlink = $('#outlink'), copyBtn = $('#copy'), openBtn = $('#open');
  const statsEl = $('#stats'), errEl = $('#err'), infoEl = $('#info'), support = $('#support');

  // ===== Feature detect & status badges
  const hasGzip = typeof CompressionStream !== 'undefined' && typeof DecompressionStream !== 'undefined';
  support.textContent = 'gzip: ' + (hasGzip ? 'OK' : 'fallback');
  support.style.borderColor = hasGzip ? '#2b5a2b' : '#5a532b';
  support.style.color = hasGzip ? '#8be38b' : '#ffcc66';

  // ===== Base64URL helpers
  const te = new TextEncoder(), td = new TextDecoder();
  function b64url(bytes){
    let bin = ''; const arr = new Uint8Array(bytes);
    for (let i=0;i<arr.length;i++) bin += String.fromCharCode(arr[i]);
    return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }

  // ===== Compression with robust error handling
  async function gzipCompress(text){
    if (!hasGzip) return { bytes: te.encode(text), compressed: false };
    try {
      const cs = new CompressionStream('gzip');
      const writer = cs.writable.getWriter();
      await writer.write(te.encode(text)); await writer.close();
      const reader = cs.readable.getReader();
      const chunks = []; let total = 0, r;
      while ((r = await reader.read()) && !r.done) { chunks.push(r.value); total += r.value.length; }
      const out = new Uint8Array(total); let o=0; for(const c of chunks){ out.set(c, o); o+=c.length; }
      return { bytes: out, compressed: true };
    } catch (e) {
      return { bytes: te.encode(text), compressed: false, error: e };
    }
  }

  function buildViewerLink(payload, t){
    const url = new URL(location.href);
    url.hash = ''; url.search = '';
    url.pathname = url.pathname.replace(/create\.html$/, 'v.html');
    const qs = new URLSearchParams(); qs.set('p', payload); if (t) qs.set('t', t.trim().slice(0,80));
    return url.origin + url.pathname + '#' + qs.toString();
  }

  function showError(msg){
    errEl.textContent = msg; errEl.style.display = 'block';
    infoEl.style.display = 'none';
  }
  function showInfo(msg){
    infoEl.textContent = msg; infoEl.style.display = 'block';
    errEl.style.display = 'none';
  }
  function clearNotices(){ errEl.style.display='none'; infoEl.style.display='none'; }

  // ===== Main action
  makeBtn.addEventListener('click', async () => {
    clearNotices();
    try {
      const val = input.value;
      if (!val || !val.trim()) { showError('Isi dulu teksnya.'); return; }

      showInfo('Mengompresi…');
      const rawBytes = te.encode(val);
      const { bytes, compressed, error } = await gzipCompress(val);
      if (error) showInfo('gzip tidak tersedia / gagal, pakai fallback (URL akan lebih panjang).');

      const payload = b64url(bytes);
      const link = buildViewerLink(payload, title.value);
      outlink.textContent = link; outlink.dataset.href = link;
      result.hidden = false;

      const ratio = rawBytes.length ? (bytes.length / rawBytes.length) : 1;
      const urlLen = link.length;
      const cls = urlLen < 2000 ? 'ok' : (urlLen < 8000 ? 'warn' : 'bad');
      statsEl.innerHTML = `<span class="${cls}">URL length: ${urlLen}</span> • compressed: <b>${bytes.length}</b> B / raw: <b>${rawBytes.length}</b> B (${(ratio*100).toFixed(1)}%) • ${compressed ? 'gzip ✅' : 'no-gzip ⚠️'}`;
      infoEl.style.display = 'none';
    } catch (e) {
      console.error(e);
      showError('Terjadi error saat bikin link. Coba ulangi atau kecilkan teks.');
    }
  });

  clearBtn.addEventListener('click', () => {
    input.value = ''; title.value = ''; result.hidden = true; statsEl.textContent = ''; clearNotices();
  });

  copyBtn.addEventListener('click', async () => {
    const link = outlink.dataset.href;
    try { await navigator.clipboard.writeText(link); showInfo('Link dicopy ✅'); }
    catch { showInfo('Copy manual: pilih dan salin teks link di atas.'); }
  });

  openBtn.addEventListener('click', () => {
    const link = outlink.dataset.href; if (link) window.open(link, '_blank');
  });

  // Prefill dari viewer
  const preText = sessionStorage.getItem('prefill_text') || '';
  const preTitle = sessionStorage.getItem('prefill_title') || '';
  if (preText) input.value = preText;
  if (preTitle) title.value = preTitle;
  sessionStorage.removeItem('prefill_text'); sessionStorage.removeItem('prefill_title');
})();
</script>
</body>
</html>
