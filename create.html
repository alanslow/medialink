<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buat Paste — PasteLink</title>
  <style>
    :root { color-scheme: light dark; }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto;margin:0;background:color-mix(in oklab, Canvas 94%, CanvasText 6%)}
    .wrap{max-width:980px;margin:0 auto;padding:32px}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    .panel{background:Canvas;border:1px solid color-mix(in oklab, CanvasText 15%, Canvas 85%);border-radius:20px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
    h1{margin:0 0 6px;font-size:clamp(20px,3vw,28px)}
    p.muted{opacity:.75;margin:.25rem 0 1rem}
    textarea{width:100%;min-height:360px;padding:14px;border-radius:16px;border:1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%);background:Canvas}
    input[type="text"]{width:100%;padding:12px;border-radius:16px;border:1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%);background:Canvas}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:12px 16px;border-radius:999px;border:1px solid color-mix(in oklab, CanvasText 20%, Canvas 80%);background:color-mix(in oklab, Canvas 88%, CanvasText 12%);cursor:pointer}
    button.ghost{background:transparent}
    .card{border:1px dashed color-mix(in oklab, CanvasText 24%, Canvas 76%);border-radius:16px;padding:14px}
    .link{word-break:break-all;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .stat{font-size:.92rem;opacity:.85}
    .ok{color:color-mix(in oklab, green 60%, CanvasText 40%)}
    .warn{color:color-mix(in oklab, orange 60%, CanvasText 40%)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <section class="panel">
        <h1>Buat Paste</h1>
        <p class="muted">Teks akan <b>dikompres (gzip)</b> lalu di-encode ke <b>Base64URL</b> dan disimpan di <b>URL hash</b> — tanpa server.</p>

        <label class="muted">Isi</label>
        <textarea id="input" placeholder="Tempel teks / kode di sini..."></textarea>

        <div class="row">
          <input id="title" type="text" placeholder="(Opsional) Judul/slug, mis. catatan-api" />
          <button id="make">Bikin Link</button>
          <button id="clear" class="ghost">Bersihkan</button>
        </div>

        <div id="stats" class="stat"></div>

        <div id="result" class="card" hidden>
          <div class="muted">Link paste kamu:</div>
          <div id="outlink" class="link"></div>
          <div class="row" style="margin-top:8px">
            <button id="copy">Copy Link</button>
            <button id="open">Buka Link</button>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
// ===== Helpers: Base64URL & (De)Compression =====
const te = new TextEncoder(), td = new TextDecoder();

function b64url(bytes){
  let bin = '';
  const arr = new Uint8Array(bytes);
  for (let i=0;i<arr.length;i++) bin += String.fromCharCode(arr[i]);
  const b64 = btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  return b64;
}
function b64urlToBytes(str){
  const b64 = str.replace(/-/g,'+').replace(/_/g,'/');
  const pad = '='.repeat((4 - b64.length % 4) % 4);
  const bin = atob(b64 + pad);
  const out = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
  return out;
}

async function gzipCompress(text){
  if (typeof CompressionStream === 'undefined') return { bytes: te.encode(text), compressed: false };
  const cs = new CompressionStream('gzip');
  const writer = cs.writable.getWriter();
  writer.write(te.encode(text)); await writer.close();
  const reader = cs.readable.getReader();
  const chunks = [];
  let total = 0, r;
  while ((r = await reader.read()) && !r.done) { chunks.push(r.value); total += r.value.length; }
  const out = new Uint8Array(total);
  let o=0; for(const c of chunks){ out.set(c, o); o+=c.length; }
  return { bytes: out, compressed: true };
}

async function gzipDecompress(bytes){
  if (typeof DecompressionStream === 'undefined') return td.decode(bytes); // fallback: assume plain
  const ds = new DecompressionStream('gzip');
  const writer = ds.writable.getWriter();
  writer.write(bytes); await writer.close();
  const reader = ds.readable.getReader();
  const chunks = [];
  let total = 0, r;
  while ((r = await reader.read()) && !r.done) { chunks.push(r.value); total += r.value.length; }
  const out = new Uint8Array(total);
  let o=0; for(const c of chunks){ out.set(c, o); o+=c.length; }
  return td.decode(out);
}

// ===== UI logic =====
const input = document.getElementById('input');
const title = document.getElementById('title');
const makeBtn = document.getElementById('make');
const clearBtn = document.getElementById('clear');
const result = document.getElementById('result');
const outlink = document.getElementById('outlink');
const copyBtn = document.getElementById('copy');
const openBtn = document.getElementById('open');
const statsEl = document.getElementById('stats');

function statLine(oBytes, cBytes, urlLen, usedGzip){
  const ratio = oBytes ? (cBytes / oBytes) : 1;
  const pct = (100*ratio).toFixed(1);
  const okWarn = urlLen < 2000 ? 'ok' : (urlLen < 8000 ? 'warn' : 'warn');
  const label = usedGzip ? 'gzip ✅' : 'no-gzip (fallback) ⚠️';
  return `<span class="${okWarn}">URL length: ${urlLen} chars</span> • compressed: <b>${cBytes}</b> B / raw: <b>${oBytes}</b> B (${pct}%) • ${label}`;
}

makeBtn.onclick = async () => {
  const val = input.value;
  if (!val.trim()) { alert('Isi dulu teksnya.'); return; }

  const rawBytes = te.encode(val);
  const { bytes, compressed } = await gzipCompress(val);
  const payload = b64url(bytes);
  const qs = new URLSearchParams();
  qs.set('p', payload);
  const t = title.value.trim(); if (t) qs.set('t', t.slice(0,80));

  const url = new URL(location.href);
  url.pathname = url.pathname.replace(/create\.html$/, 'v.html');
  url.search = '';
  const link = url.origin + url.pathname + '#' + qs.toString();

  outlink.textContent = link;
  outlink.dataset.href = link;
  result.hidden = false;

  statsEl.innerHTML = statLine(rawBytes.length, bytes.length, link.length, compressed);
};

clearBtn.onclick = () => {
  input.value = ''; title.value = ''; result.hidden = true; statsEl.textContent = '';
};

copyBtn.onclick = async () => {
  const link = outlink.dataset.href;
  try { await navigator.clipboard.writeText(link); alert('Link dicopy ✅'); }
  catch { prompt('Copy manual:', link); }
};

openBtn.onclick = () => {
  const link = outlink.dataset.href;
  if (link) window.open(link, '_blank');
};

// Prefill dari viewer (opsional)
const preText = sessionStorage.getItem('prefill_text') || '';
const preTitle = sessionStorage.getItem('prefill_title') || '';
if (preText) input.value = preText;
if (preTitle) title.value = preTitle;
sessionStorage.removeItem('prefill_text'); sessionStorage.removeItem('prefill_title');
</script>
</body>
</html>
