<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stats — Pasteku</title>
<style>
  :root{
    --fg:#0f172a; --muted:#475569; --soft:#f8fafc; --border:#e5e7eb; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
    --brand:#111827; --brandfg:#fff; --chip:#e2e8f0;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto;color:var(--fg);background:#fff}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
  .nav{max-width:1100px;margin:0 auto;padding:14px 22px;display:flex;align-items:center;gap:12px}
  .brand{font-weight:700}
  .nav a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:8px 12px;border-radius:10px;background:var(--soft)}
  .wrap{max-width:1100px;margin:0 auto;padding:22px}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:520px){ .grid{grid-template-columns:1fr} }
  .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 6px 16px rgba(2,6,23,.05)}
  .kpi .label{color:var(--muted);font-size:.9rem}
  .kpi .val{font-size:1.8rem;font-weight:800;margin-top:4px}
  .kpi .chip{display:inline-block;margin-top:6px;padding:4px 8px;border-radius:999px;background:var(--chip);font-size:.8rem;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(2,6,23,.05);margin-top:14px}
  h2{margin:0 0 8px;font-size:1.1rem}
  input[type=text], select{padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--soft)}
  button{padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .primary{background:var(--brand);color:var(--brandfg);border:none}
  table{width:100%;border-collapse:collapse;font-size:.95rem}
  th, td{border-bottom:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
  th{font-size:.85rem;color:var(--muted)}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .nowrap{white-space:nowrap}
  .barwrap{height:8px;background:var(--soft);border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .bar{height:100%;background:#2563eb;width:0%}
  .statline{display:flex;gap:8px;align-items:center}
  .tag{display:inline-block;padding:2px 6px;border:1px solid var(--border);border-radius:6px;background:var(--soft);font-size:.8rem;color:var(--muted)}
  .right{margin-left:auto}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">Pasteku — Stats</div>
    <a href="./">Home</a>
    <button id="refresh">Refresh</button>
    <span id="status" class="tag">cek…</span>
    <div class="right"></div>
    <input id="q" type="text" placeholder="Cari judul/ID…" />
  </div>
</header>

<div class="wrap">
  <!-- KPIs -->
  <section class="grid">
    <div class="kpi"><div class="label">Total</div><div id="k_total" class="val">–</div></div>
    <div class="kpi"><div class="label">Aktif</div><div id="k_active" class="val">–</div></div>
    <div class="kpi"><div class="label">Expired</div><div id="k_expired" class="val">–</div></div>
    <div class="kpi"><div class="label">24 jam</div><div id="k_24h" class="val">–</div></div>
    <div class="kpi"><div class="label">7 hari</div><div id="k_7d" class="val">–</div></div>
  </section>

  <!-- Top viewed -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <h2>Top 10 berdasarkan Views</h2>
      <div class="muted" id="maxViewsNote"></div>
    </div>
    <table id="topTable">
      <thead><tr>
        <th style="width:46px">#</th>
        <th>ID/Slug</th>
        <th>Judul</th>
        <th class="nowrap">Views</th>
        <th style="width:220px">Grafik</th>
        <th class="nowrap">Dibuat</th>
        <th></th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Latest -->
  <section class="card">
    <h2>20 Terbaru</h2>
    <table id="latestTable">
      <thead><tr>
        <th>ID/Slug</th>
        <th>Judul</th>
        <th class="nowrap">Dibuat</th>
        <th class="nowrap">Expire</th>
        <th class="nowrap">Views</th>
        <th></th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<script>
/* ===== Supabase config (punya kamu) ===== */
const SB_URL = "https://eqhkqmmomzsddnnzjtls.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxaGtxbW1vbXpzZGRubnpqdGxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTA2MzYsImV4cCI6MjA3NDI2NjYzNn0.8-tNO0T4GMM5bPHmK_ZGP-oL-HM3YcFYQ28vxm1Qvrw";
/* ======================================= */

const $ = s => document.querySelector(s);
const statusTag = $('#status'), q = $('#q');

function viewerURL(id){ return location.origin + "/v/" + encodeURIComponent(id); }

/* ---- helpers ---- */
function iso(dt){ return dt.toISOString(); }
function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); return d; }
function hoursAgo(n){ const d=new Date(); d.setHours(d.getHours()-n); return d; }
function fmtDate(s){ try{ return new Date(s).toLocaleString(); }catch{ return s; } }

/* Count via `Prefer: count=exact` + Content-Range */
async function countByQuery(query){
  const url = `${SB_URL}/rest/v1/pastes?select=id&${query}`;
  const r = await fetch(url, {
    headers: { apikey: SB_KEY, Authorization: "Bearer "+SB_KEY, Prefer: "count=exact" },
    // we only need 1 row to get total count from header
    method: "GET"
  });
  const cr = r.headers.get("Content-Range"); // e.g. "0-0/123"
  if (!cr) return null;
  const total = cr.split('/')[1];
  return parseInt(total,10);
}

async function getKPIs(){
  const nowISO = iso(new Date());
  const d24 = iso(hoursAgo(24));
  const d7d = iso(daysAgo(7));

  // total
  const total = await countByQuery("");
  // active: expires_at is null OR expires_at > now
  const active = await countByQuery(`or=(expires_at.is.null,expires_at.gt.${encodeURIComponent(nowISO)})`);
  const expired = total!=null && active!=null ? Math.max(total - active, 0) : null;
  const last24 = await countByQuery(`created_at.gte.${encodeURIComponent(d24)}`);
  const last7d = await countByQuery(`created_at.gte.${encodeURIComponent(d7d)}`);

  $('#k_total').textContent = total ?? '–';
  $('#k_active').textContent = active ?? '–';
  $('#k_expired').textContent = expired ?? '–';
  $('#k_24h').textContent = last24 ?? '–';
  $('#k_7d').textContent = last7d ?? '–';
}

/* Top 10 views */
async function getTop(limit=10){
  const url = `${SB_URL}/rest/v1/pastes?select=id,title,views,created_at&order=views.desc,nullslast&limit=${limit}`;
  const r = await fetch(url, { headers: { apikey: SB_KEY, Authorization: "Bearer "+SB_KEY }});
  if(!r.ok) throw new Error(r.statusText);
  return r.json();
}

/* Latest 20 */
async function getLatest(limit=20, searchTerm=""){
  const params = new URLSearchParams();
  params.set("select","id,title,views,created_at,expires_at");
  params.set("order","created_at.desc");
  params.set("limit", String(limit));
  if (searchTerm) {
    // ilike pada title OR id
    const term = `%${searchTerm}%`;
    params.set("or", `(title.ilike.${encodeURIComponent(term)},id.ilike.${encodeURIComponent(term)})`);
  }
  const url = `${SB_URL}/rest/v1/pastes?${params.toString()}`;
  const r = await fetch(url, { headers: { apikey: SB_KEY, Authorization: "Bearer "+SB_KEY }});
  if(!r.ok) throw new Error(r.statusText);
  return r.json();
}

/* Renderers */
function renderTop(rows){
  const tb = $('#topTable tbody'); tb.innerHTML = '';
  const maxV = Math.max(1, ...rows.map(r => r.views || 0));
  $('#maxViewsNote').textContent = `max: ${maxV} views`;
  rows.forEach((r, i) => {
    const tr = document.createElement('tr');
    const pct = Math.round(((r.views||0)/maxV)*100);
    tr.innerHTML = `
      <td class="mono">${i+1}</td>
      <td class="mono">${r.id}</td>
      <td>${r.title ? escapeHTML(r.title) : '<span class="muted">—</span>'}</td>
      <td class="mono">${r.views ?? 0}</td>
      <td>
        <div class="barwrap"><div class="bar" style="width:${pct}%;"></div></div>
      </td>
      <td class="nowrap">${fmtDate(r.created_at)}</td>
      <td><a href="${viewerURL(r.id)}" target="_blank" rel="noopener">buka</a></td>
    `;
    tb.appendChild(tr);
  });
}

function renderLatest(rows){
  const tb = $('#latestTable tbody'); tb.innerHTML = '';
  rows.forEach(r => {
    const exp = r.expires_at ? fmtDate(r.expires_at) : '<span class="muted">–</span>';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${r.id}</td>
      <td>${r.title ? escapeHTML(r.title) : '<span class="muted">—</span>'}</td>
      <td class="nowrap">${fmtDate(r.created_at)}</td>
      <td class="nowrap">${exp}</td>
      <td class="mono">${r.views ?? 0}</td>
      <td><a href="${viewerURL(r.id)}" target="_blank" rel="noopener">buka</a></td>
    `;
    tb.appendChild(tr);
  });
}

function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Load all */
async function loadAll(){
  try{
    statusTag.textContent = 'memuat…';
    await getKPIs();
    const [top, latest] = await Promise.all([getTop(), getLatest(20, q.value.trim())]);
    renderTop(top);
    renderLatest(latest);
    statusTag.textContent = 'siap';
  }catch(e){
    statusTag.textContent = 'error';
    console.error(e);
  }
}

/* Events */
$('#refresh').onclick = loadAll;
q.addEventListener('input', () => { loadAll(); });

/* init */
loadAll();
</script>
</body>
  </html>
